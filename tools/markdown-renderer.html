<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Markdown Renderer</title>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,300..700;1,9..40,300..700&family=JetBrains+Mono:ital,wght@0,400;0,500;0,600;1,400&display=swap" rel="stylesheet" />

  <!-- Shared design system -->
  <link rel="stylesheet" href="../shared/tokens.css" />
  <link rel="stylesheet" href="../shared/base.css" />
  <link rel="stylesheet" href="../shared/components.css" />

  <!-- Highlight.js -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.10.0/styles/github-dark.min.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.10.0/highlight.min.js"></script>

  <!-- marked.js -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <!-- DOMPurify -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.1.6/purify.min.js"></script>

  <!-- Mermaid -->
  <script src="https://cdn.jsdelivr.net/npm/mermaid@11/dist/mermaid.min.js"></script>

  <style>
    /* â”€â”€ Reset & Base â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --preview-bg:                  #1e1e1e;
      --preview-code-bg:             #2d2d2d;
      --preview-blockquote-border:   #569cd6;
      --preview-table-alt:           #252526;
      --preview-hr:                  #3c3c3c;
      --preview-link:                #569cd6;
    }

    html, body {
      height: 100%;
      background: var(--color-bg);
      color: var(--color-text);
      font-family: var(--font-ui);
      font-size: 14px;
      line-height: 1.5;
      overflow: hidden;
    }

    /* â”€â”€ Layout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #app {
      display: flex;
      flex-direction: column;
      height: 100vh;
    }

    /* â”€â”€ Header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #header {
      flex-shrink: 0;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 16px;
      height: 44px;
      background: var(--color-bg-panel);
      border-bottom: 1px solid var(--color-border);
      gap: 12px;
    }

    #header-left {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    #header-icon {
      width: 22px;
      height: 22px;
      opacity: 0.85;
    }

    #header-title {
      font-size: 13px;
      font-weight: 600;
      color: var(--color-text);
      letter-spacing: 0.02em;
      white-space: nowrap;
    }

    /* Mode toggle pill */
    #mode-toggle {
      display: flex;
      align-items: center;
      background: var(--color-bg);
      border: 1px solid var(--color-border);
      border-radius: 20px;
      padding: 3px;
      gap: 2px;
    }

    .mode-btn {
      padding: 4px 14px;
      border: none;
      background: transparent;
      color: var(--color-text-secondary);
      font-family: var(--font-ui);
      font-size: 12px;
      font-weight: 500;
      border-radius: 16px;
      cursor: pointer;
      transition: background 0.15s, color 0.15s;
      white-space: nowrap;
    }

    .mode-btn:hover {
      color: var(--color-text);
      background: var(--color-bg-hover);
    }

    .mode-btn.active {
      background: var(--color-accent);
      color: #fff;
    }

    /* â”€â”€ Toolbar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #toolbar {
      flex-shrink: 0;
      display: flex;
      align-items: center;
      padding: 0 12px;
      height: 36px;
      background: var(--color-bg-toolbar);
      border-bottom: 1px solid var(--color-border);
      gap: 4px;
    }

    .tb-btn {
      display: flex;
      align-items: center;
      gap: 5px;
      padding: 4px 10px;
      border: 1px solid transparent;
      background: transparent;
      color: var(--color-text-secondary);
      font-family: var(--font-ui);
      font-size: 12px;
      border-radius: var(--radius-control);
      cursor: pointer;
      transition: background 0.12s, color 0.12s, border-color 0.12s;
    }

    .tb-btn:hover {
      background: var(--color-bg-hover);
      color: var(--color-text);
      border-color: var(--color-border-light);
    }

    .tb-btn svg { flex-shrink: 0; }

    .tb-sep {
      width: 1px;
      height: 18px;
      background: var(--color-border);
      margin: 0 4px;
    }

    #char-count {
      margin-left: auto;
      font-size: 11px;
      color: var(--color-text-muted);
      font-family: var(--font-mono);
    }

    /* â”€â”€ Main content area â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #content {
      flex: 1;
      display: flex;
      overflow: hidden;
      position: relative;
    }

    /* â”€â”€ Editor pane â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #editor-pane {
      display: flex;
      flex-direction: column;
      width: 50%;
      min-width: 0;
      border-right: 1px solid var(--color-border);
      transition: width 0.2s ease, opacity 0.2s ease;
      overflow: hidden;
    }

    #editor-pane.hidden {
      width: 0 !important;
      opacity: 0;
      border-right: none;
      pointer-events: none;
    }

    #editor-pane.full {
      width: 100%;
    }

    #editor-label {
      flex-shrink: 0;
      padding: 5px 14px;
      font-size: 11px;
      font-weight: 600;
      color: var(--color-text-muted);
      letter-spacing: 0.08em;
      text-transform: uppercase;
      background: var(--color-bg-panel);
      border-bottom: 1px solid var(--color-border);
    }

    #editor {
      flex: 1;
      width: 100%;
      padding: 20px 22px;
      background: var(--color-bg);
      color: var(--color-text);
      font-family: var(--font-mono);
      font-size: 13.5px;
      line-height: 1.65;
      border: none;
      outline: none;
      resize: none;
      overflow-y: auto;
      tab-size: 2;
    }

    #editor::placeholder {
      color: var(--color-text-muted);
    }

    #editor::-webkit-scrollbar { width: 8px; }
    #editor::-webkit-scrollbar-track { background: transparent; }
    #editor::-webkit-scrollbar-thumb { background: var(--color-border-light); border-radius: 4px; }

    /* â”€â”€ Divider handle â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #divider {
      flex-shrink: 0;
      width: 4px;
      background: var(--color-border);
      cursor: col-resize;
      transition: background 0.15s;
      position: relative;
    }

    #divider:hover { background: var(--color-accent); }

    #divider.hidden { display: none; }

    /* â”€â”€ Preview pane â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #preview-pane {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-width: 0;
      overflow: hidden;
      transition: opacity 0.2s ease;
    }

    #preview-pane.hidden {
      width: 0;
      opacity: 0;
      pointer-events: none;
      overflow: hidden;
    }

    #preview-label {
      flex-shrink: 0;
      padding: 5px 14px;
      font-size: 11px;
      font-weight: 600;
      color: var(--color-text-muted);
      letter-spacing: 0.08em;
      text-transform: uppercase;
      background: var(--color-bg-panel);
      border-bottom: 1px solid var(--color-border);
    }

    #preview {
      flex: 1;
      overflow-y: auto;
      padding: 28px 36px;
      background: var(--preview-bg);
    }

    #preview.full-prose {
      padding: 40px max(36px, calc(50% - 380px));
    }

    #preview::-webkit-scrollbar { width: 8px; }
    #preview::-webkit-scrollbar-track { background: transparent; }
    #preview::-webkit-scrollbar-thumb { background: var(--color-border-light); border-radius: 4px; }

    /* â”€â”€ Status bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #statusbar {
      flex-shrink: 0;
      display: flex;
      align-items: center;
      padding: 0 14px;
      height: 22px;
      background: var(--color-accent);
      font-size: 11px;
      color: #fff;
      gap: 12px;
    }

    #status-mode {
      font-weight: 600;
      letter-spacing: 0.04em;
    }

    #status-mermaid {
      display: none;
      align-items: center;
      gap: 4px;
      background: rgba(255,255,255,0.18);
      padding: 1px 8px;
      border-radius: 10px;
      font-size: 10.5px;
      font-weight: 600;
      letter-spacing: 0.04em;
    }

    #status-mermaid.visible {
      display: flex;
    }

    #status-shortcuts {
      margin-left: auto;
      opacity: 0.75;
      font-size: 10.5px;
    }

    /* â”€â”€ Toast â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #toast {
      position: fixed;
      bottom: 36px;
      left: 50%;
      transform: translateX(-50%) translateY(12px);
      background: var(--color-bg-panel);
      border: 1px solid var(--color-border-light);
      color: var(--color-text);
      font-size: 12.5px;
      padding: 7px 16px;
      border-radius: 20px;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.2s, transform 0.2s;
      z-index: 999;
      white-space: nowrap;
      box-shadow: 0 4px 20px rgba(0,0,0,0.5);
    }

    #toast.show {
      opacity: 1;
      transform: translateX(-50%) translateY(0);
    }

    /* â”€â”€ Prose styles (preview content) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .prose {
      font-family: var(--font-ui);
      font-size: 15px;
      line-height: 1.75;
      color: var(--color-text);
      max-width: 100%;
    }

    .prose h1, .prose h2, .prose h3,
    .prose h4, .prose h5, .prose h6 {
      font-weight: 600;
      margin: 1.5em 0 0.6em;
      line-height: 1.3;
      color: #e6e6e6;
    }

    .prose h1 { font-size: 1.95em; padding-bottom: 0.3em; border-bottom: 1px solid var(--color-border-light); }
    .prose h2 { font-size: 1.55em; padding-bottom: 0.25em; border-bottom: 1px solid var(--color-border); }
    .prose h3 { font-size: 1.25em; }
    .prose h4 { font-size: 1.05em; }
    .prose h5 { font-size: 0.95em; }
    .prose h6 { font-size: 0.9em; color: var(--color-text-secondary); }

    .prose p { margin: 0.9em 0; }

    .prose a { color: var(--preview-link); text-decoration: underline; text-underline-offset: 2px; }
    .prose a:hover { color: #7cb8e8; }

    .prose strong { font-weight: 600; color: #e6e6e6; }
    .prose em { color: #d4d4d4; }
    .prose del { color: var(--color-text-muted); }

    .prose code {
      font-family: var(--font-mono);
      font-size: 0.875em;
      background: var(--preview-code-bg);
      border: 1px solid var(--color-border);
      border-radius: 3px;
      padding: 0.15em 0.4em;
      color: var(--color-success);
    }

    .prose pre {
      background: #0d1117;
      border: 1px solid var(--color-border);
      border-radius: 6px;
      padding: 16px 20px;
      overflow-x: auto;
      margin: 1.2em 0;
    }

    .prose pre::-webkit-scrollbar { height: 6px; }
    .prose pre::-webkit-scrollbar-thumb { background: var(--color-border-light); border-radius: 3px; }

    .prose pre code {
      font-family: var(--font-mono);
      font-size: 13px;
      background: none;
      border: none;
      padding: 0;
      color: inherit;
      border-radius: 0;
    }

    .prose blockquote {
      margin: 1.2em 0;
      padding: 10px 18px;
      border-left: 3px solid var(--preview-blockquote-border);
      background: rgba(86, 156, 214, 0.06);
      border-radius: 0 4px 4px 0;
      color: var(--color-text-secondary);
    }

    .prose blockquote p { margin: 0.4em 0; }

    .prose ul, .prose ol {
      margin: 0.8em 0;
      padding-left: 1.8em;
    }

    .prose li { margin: 0.3em 0; }
    .prose li > ul, .prose li > ol { margin: 0.3em 0; }

    /* Task list */
    .prose ul.contains-task-list { list-style: none; padding-left: 0.5em; }
    .prose .task-list-item { display: flex; align-items: flex-start; gap: 8px; }
    .prose .task-list-item input[type="checkbox"] {
      margin-top: 4px;
      flex-shrink: 0;
      accent-color: var(--color-accent);
      width: 14px;
      height: 14px;
      cursor: default;
    }

    .prose table {
      border-collapse: collapse;
      width: 100%;
      margin: 1.2em 0;
      font-size: 0.93em;
    }

    .prose table th {
      background: var(--color-bg-toolbar);
      color: var(--color-text);
      font-weight: 600;
      text-align: left;
      padding: 8px 14px;
      border: 1px solid var(--color-border-light);
    }

    .prose table td {
      padding: 7px 14px;
      border: 1px solid var(--color-border);
    }

    .prose table tr:nth-child(even) td {
      background: var(--preview-table-alt);
    }

    .prose hr {
      border: none;
      border-top: 1px solid var(--preview-hr);
      margin: 2em 0;
    }

    .prose img {
      max-width: 100%;
      border-radius: 4px;
      border: 1px solid var(--color-border);
    }

    /* Mermaid wrapper */
    .mermaid-wrapper {
      margin: 1.4em 0;
      background: #161616;
      border: 1px solid var(--color-border);
      border-radius: 8px;
      padding: 24px 20px;
      text-align: center;
      overflow-x: auto;
      position: relative;
    }

    .mermaid-wrapper .mermaid { display: inline-block; }
    .mermaid-wrapper svg { max-width: 100%; height: auto; }

    /* Expand button on mermaid-wrapper */
    .mermaid-expand-btn {
      position: absolute;
      top: 10px;
      right: 10px;
      width: 28px;
      height: 28px;
      border: 1px solid var(--color-border-light);
      border-radius: var(--radius-control);
      background: var(--color-bg-toolbar);
      color: var(--color-text-secondary);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      transition: opacity 0.18s, background 0.12s, color 0.12s;
      z-index: 2;
    }
    .mermaid-wrapper:hover .mermaid-expand-btn { opacity: 1; }
    .mermaid-expand-btn:hover {
      background: var(--color-bg-hover);
      color: var(--color-text);
      border-color: var(--color-accent);
    }

    /* â”€â”€ Diagram viewer modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #diagram-modal {
      display: none;
      position: fixed;
      inset: 0;
      z-index: 1000;
      background: rgba(0,0,0,0.88);
      flex-direction: column;
      opacity: 0;
      transition: opacity 0.18s ease;
    }
    #diagram-modal.open {
      display: flex;
    }
    #diagram-modal.visible {
      opacity: 1;
    }

    /* Modal toolbar */
    #dm-toolbar {
      flex-shrink: 0;
      display: flex;
      align-items: center;
      height: 40px;
      background: var(--color-bg-toolbar);
      border-bottom: 1px solid var(--color-border);
      padding: 0 12px;
      gap: 8px;
      font-family: var(--font-ui);
      font-size: 12px;
    }
    #dm-title {
      color: var(--color-text-secondary);
      font-size: 11px;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      font-weight: 600;
      flex: 1;
    }
    #dm-zoom-display {
      font-family: var(--font-mono);
      font-size: 11px;
      color: var(--color-text-secondary);
      min-width: 44px;
      text-align: center;
    }
    .dm-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
      height: 26px;
      padding: 0 10px;
      border: 1px solid var(--color-border-light);
      border-radius: var(--radius-control);
      background: var(--color-bg);
      color: var(--color-text-secondary);
      font-family: var(--font-ui);
      font-size: 12px;
      cursor: pointer;
      transition: background 0.12s, color 0.12s, border-color 0.12s;
      white-space: nowrap;
    }
    .dm-btn:hover { background: var(--color-bg-hover); color: var(--color-text); border-color: var(--color-accent); }
    .dm-btn.icon { width: 26px; padding: 0; }
    #dm-zoom-controls { display: flex; align-items: center; gap: 4px; }
    #dm-close {
      margin-left: 8px;
      border-color: transparent;
      background: transparent;
      color: var(--color-text-secondary);
      font-size: 18px;
      line-height: 1;
      width: 28px;
      height: 28px;
      padding: 0;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    #dm-close:hover { color: var(--color-error); background: rgba(244,71,71,0.1); border-color: rgba(244,71,71,0.3); }

    /* Canvas area */
    #dm-canvas {
      flex: 1;
      overflow: hidden;
      position: relative;
      cursor: grab;
      /* dot-grid to convey infinite space */
      background-color: #141414;
      background-image: radial-gradient(circle, #3c3c3c 1px, transparent 1px);
      background-size: 28px 28px;
    }
    #dm-canvas.dragging { cursor: grabbing; }
    #dm-inner {
      position: absolute;
      top: 50%;
      left: 50%;
      transform-origin: center center;
      /* JS sets transform: translate(-50%,-50%) translate(Xpx,Ypx) scale(Z) */
    }
    #dm-inner svg {
      display: block;
      filter: drop-shadow(0 4px 24px rgba(0,0,0,0.7));
    }

    /* Zoom badge bottom-right */
    #dm-zoom-badge {
      position: absolute;
      bottom: 14px;
      right: 14px;
      background: rgba(37,37,38,0.9);
      border: 1px solid var(--color-border-light);
      border-radius: 10px;
      padding: 3px 10px;
      font-family: var(--font-mono);
      font-size: 11px;
      color: var(--color-text-secondary);
      pointer-events: none;
      backdrop-filter: blur(4px);
    }

    .mermaid-error {
      color: var(--color-error);
      font-family: var(--font-mono);
      font-size: 12px;
      padding: 12px;
    }

    /* hljs overrides for consistent look */
    .hljs { background: transparent !important; padding: 0 !important; }
  </style>
</head>
<body>
<div id="app">

  <!-- Header -->
  <div id="header">
    <div id="header-left">
      <svg id="header-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.7" stroke-linecap="round" stroke-linejoin="round" style="color:var(--color-accent)">
        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
        <polyline points="14,2 14,8 20,8"/>
        <line x1="16" y1="13" x2="8" y2="13"/>
        <line x1="16" y1="17" x2="8" y2="17"/>
        <polyline points="10,9 9,9 8,9"/>
      </svg>
      <span id="header-title">Markdown Renderer</span>
    </div>

    <div id="mode-toggle">
      <button class="mode-btn" data-mode="edit" title="Edit only (Ctrl+Shift+E)">Edit</button>
      <button class="mode-btn active" data-mode="split" title="Split view">Split</button>
      <button class="mode-btn" data-mode="preview" title="Preview only (Ctrl+E)">Preview</button>
    </div>
  </div>

  <!-- Toolbar -->
  <div id="toolbar">
    <button class="tb-btn" id="btn-copy-md" title="Copy markdown source">
      <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/>
      </svg>
      Copy Markdown
    </button>
    <button class="tb-btn" id="btn-copy-html" title="Copy rendered HTML">
      <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <polyline points="16,18 22,12 16,6"/><polyline points="8,6 2,12 8,18"/>
      </svg>
      Copy HTML
    </button>
    <div class="tb-sep"></div>
    <button class="tb-btn" id="btn-load-sample" title="Load sample markdown">
      <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M12 2L2 7l10 5 10-5-10-5z"/><path d="M2 17l10 5 10-5"/><path d="M2 12l10 5 10-5"/>
      </svg>
      Load Sample
    </button>
    <button class="tb-btn" id="btn-clear" title="Clear editor">
      <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <polyline points="3,6 5,6 21,6"/><path d="M19,6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3,0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2,2v2"/>
      </svg>
      Clear
    </button>
    <span id="char-count">0 chars</span>
  </div>

  <!-- Content -->
  <div id="content">
    <div id="editor-pane">
      <div id="editor-label">Editor</div>
      <textarea id="editor" spellcheck="false" placeholder="Paste or type your Markdown hereâ€¦"></textarea>
    </div>
    <div id="divider"></div>
    <div id="preview-pane">
      <div id="preview-label">Preview</div>
      <div id="preview"><div class="prose" id="prose-content"></div></div>
    </div>
  </div>

  <!-- Status bar -->
  <div id="statusbar">
    <span id="status-mode">SPLIT</span>
    <span id="status-mermaid">
      <svg width="11" height="11" viewBox="0 0 24 24" fill="currentColor"><circle cx="12" cy="12" r="10"/></svg>
      MERMAID
    </span>
    <span id="status-shortcuts">Ctrl+E â€” Preview &nbsp;Â·&nbsp; Ctrl+Shift+E â€” Edit</span>
  </div>
</div>

<div id="toast"></div>

<!-- Diagram viewer modal -->
<div id="diagram-modal">
  <div id="dm-toolbar">
    <span id="dm-title">Diagram</span>
    <div id="dm-zoom-controls">
      <button class="dm-btn icon" id="dm-btn-zoom-out" title="Zoom out (-)">&#x2212;</button>
      <span id="dm-zoom-display">100%</span>
      <button class="dm-btn icon" id="dm-btn-zoom-in" title="Zoom in (+)">+</button>
      <button class="dm-btn" id="dm-btn-fit" title="Fit to screen (0)">Fit</button>
    </div>
    <button class="dm-btn icon" id="dm-close" title="Close (Esc)">&#215;</button>
  </div>
  <div id="dm-canvas">
    <div id="dm-inner"></div>
    <div id="dm-zoom-badge">100%</div>
  </div>
</div>

<script>
(() => {
  /* â”€â”€ Config â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  const LS_KEY = 'md-renderer-content';
  const DEBOUNCE_MS = 150;

  /* â”€â”€ Mermaid init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  mermaid.initialize({
    startOnLoad: false,
    theme: 'dark',
    securityLevel: 'loose',
    fontFamily: "'JetBrains Mono', monospace",
  });

  /* â”€â”€ marked config â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  marked.setOptions({
    gfm: true,
    breaks: false,
    pedantic: false,
  });

  // GFM task list extension
  const taskListExtension = {
    name: 'taskList',
    level: 'block',
    start(src) { return src.indexOf('- ['); },
    tokenizer(src) {
      const match = src.match(/^(?:- \[[ xX]\] [^\n]*(?:\n|$))+/);
      if (match) {
        const lines = match[0].trim().split('\n');
        const items = lines.map(line => {
          const checked = /^- \[[xX]\]/.test(line);
          const text = line.replace(/^- \[[ xX]\] /, '');
          return { checked, text };
        });
        return {
          type: 'taskList',
          raw: match[0],
          items,
        };
      }
    },
    renderer(token) {
      const items = token.items.map(item =>
        `<li class="task-list-item"><input type="checkbox" ${item.checked ? 'checked' : ''} disabled> <span>${marked.parseInline(item.text)}</span></li>`
      ).join('');
      return `<ul class="contains-task-list">${items}</ul>`;
    }
  };

  marked.use({ extensions: [taskListExtension] });

  /* â”€â”€ DOM refs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  const editor       = document.getElementById('editor');
  const proseContent = document.getElementById('prose-content');
  const preview      = document.getElementById('preview');
  const editorPane   = document.getElementById('editor-pane');
  const previewPane  = document.getElementById('preview-pane');
  const divider      = document.getElementById('divider');
  const charCount    = document.getElementById('char-count');
  const statusMode   = document.getElementById('status-mode');
  const statusMermaid= document.getElementById('status-mermaid');
  const modeButtons  = document.querySelectorAll('.mode-btn');
  const toast        = document.getElementById('toast');

  let currentMode = 'split';
  let renderTimer = null;
  let mermaidCounter = 0;

  /* â”€â”€ DOMPurify config â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  const PURIFY_CONFIG = {
    ADD_TAGS: [
      'svg','path','circle','rect','line','polyline','polygon','text','tspan',
      'g','defs','use','marker','clipPath','linearGradient','radialGradient',
      'stop','pattern','image','foreignObject','title','desc','style',
      'switch','symbol','animate','animateTransform','set',
    ],
    ADD_ATTR: [
      'viewBox','xmlns','xmlns:xlink','xlink:href','href','x','y','width','height',
      'fill','stroke','stroke-width','stroke-linecap','stroke-linejoin','d',
      'points','cx','cy','r','rx','ry','transform','opacity','font-family',
      'font-size','font-weight','text-anchor','alignment-baseline','dominant-baseline',
      'marker-end','marker-start','marker-mid','refX','refY','orient','markerWidth',
      'markerHeight','markerUnits','clip-path','clipPathUnits','offset','stop-color',
      'stop-opacity','gradientUnits','gradientTransform','x1','y1','x2','y2',
      'spreadMethod','preserveAspectRatio','patternUnits','class','style',
      'id','data-id','type','checked','disabled','tabindex','aria-label',
    ],
    FORCE_BODY: false,
  };

  /* â”€â”€ Render pipeline â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  function extractMermaid(src) {
    const blocks = [];
    // Replace mermaid fences with empty placeholder divs BEFORE marked/DOMPurify.
    // Mermaid source is stored in `blocks` and injected via textContent AFTER
    // sanitization, so DOMPurify never sees or mangles the diagram syntax.
    const processed = src.replace(/```mermaid\n([\s\S]*?)```/gi, (_, code) => {
      const id = `mermaid-block-${++mermaidCounter}`;
      blocks.push({ id, code: code.trim() });
      // Empty placeholder â€” no raw Mermaid text goes through DOMPurify
      return `<div class="mermaid-wrapper" id="${id}-wrapper"><div class="mermaid" id="${id}"></div></div>`;
    });
    return { processed, blocks };
  }

  async function renderMermaidBlocks(blocks) {
    let diagramIndex = 0;
    for (const { id, code } of blocks) {
      const el = document.getElementById(id);
      if (!el) continue;
      diagramIndex++;
      try {
        // Pass `code` directly â€” never touched by DOMPurify
        const { svg } = await mermaid.render(`mermaid-svg-${id}`, code);
        el.innerHTML = svg;
        // Inject expand button
        const wrapper = document.getElementById(`${id}-wrapper`);
        if (wrapper) {
          const btn = document.createElement('button');
          btn.className = 'mermaid-expand-btn';
          btn.title = 'Open in viewer';
          btn.setAttribute('aria-label', 'Open diagram in fullscreen viewer');
          btn.innerHTML = `<svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"/></svg>`;
          const capturedIndex = diagramIndex;
          btn.addEventListener('click', () => {
            const svgEl = el.querySelector('svg');
            if (svgEl) openDiagramModal(svgEl.cloneNode(true), `Diagram ${capturedIndex}`);
          });
          wrapper.appendChild(btn);
        }
      } catch (err) {
        el.innerHTML = `<div class="mermaid-error">âš  Mermaid error: ${escHtml(err.message || String(err))}</div>`;
      }
    }
  }

  function escHtml(str) {
    return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
  }

  async function render() {
    const src = editor.value;

    if (!src.trim()) {
      proseContent.innerHTML = `<p style="color:var(--color-text-muted);font-style:italic;margin-top:8px">Nothing to preview. Start typing or paste Markdown on the left.</p>`;
      statusMermaid.classList.remove('visible');
      return;
    }

    mermaidCounter = 0;
    const { processed, blocks } = extractMermaid(src);
    const rawHtml = marked.parse(processed);
    const safeHtml = DOMPurify.sanitize(rawHtml, PURIFY_CONFIG);

    proseContent.innerHTML = safeHtml;

    // Highlight code blocks (skip mermaid wrappers)
    proseContent.querySelectorAll('pre code').forEach(el => {
      if (!el.closest('.mermaid-wrapper')) hljs.highlightElement(el);
    });

    // Render mermaid
    if (blocks.length > 0) {
      statusMermaid.classList.add('visible');
      await renderMermaidBlocks(blocks);
    } else {
      statusMermaid.classList.remove('visible');
    }
  }

  function scheduleRender() {
    clearTimeout(renderTimer);
    renderTimer = setTimeout(render, DEBOUNCE_MS);
  }

  /* â”€â”€ Mode switching â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  function setMode(mode) {
    currentMode = mode;

    modeButtons.forEach(b => b.classList.toggle('active', b.dataset.mode === mode));
    statusMode.textContent = mode.toUpperCase();

    editorPane.classList.remove('hidden', 'full');
    previewPane.classList.remove('hidden', 'full');
    divider.classList.remove('hidden');
    preview.classList.remove('full-prose');

    if (mode === 'edit') {
      previewPane.classList.add('hidden');
      editorPane.classList.add('full');
      divider.classList.add('hidden');
    } else if (mode === 'preview') {
      editorPane.classList.add('hidden');
      divider.classList.add('hidden');
      preview.classList.add('full-prose');
    }
    // split = default, no class changes needed
  }

  modeButtons.forEach(btn => {
    btn.addEventListener('click', () => setMode(btn.dataset.mode));
  });

  /* â”€â”€ Keyboard shortcuts â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  document.addEventListener('keydown', e => {
    // Modal keyboard shortcuts (no modifier needed)
    if (dmModalOpen) {
      if (e.key === 'Escape') { e.preventDefault(); closeDiagramModal(); return; }
      if (e.key === '+' || e.key === '=') { e.preventDefault(); dmZoomBy(0.15); return; }
      if (e.key === '-') { e.preventDefault(); dmZoomBy(-0.15); return; }
      if (e.key === '0') { e.preventDefault(); dmFit(); return; }
      if (e.key === 'ArrowLeft')  { e.preventDefault(); dmPanX += 40; dmApplyTransform(); return; }
      if (e.key === 'ArrowRight') { e.preventDefault(); dmPanX -= 40; dmApplyTransform(); return; }
      if (e.key === 'ArrowUp')    { e.preventDefault(); dmPanY += 40; dmApplyTransform(); return; }
      if (e.key === 'ArrowDown')  { e.preventDefault(); dmPanY -= 40; dmApplyTransform(); return; }
    }

    const mod = e.ctrlKey || e.metaKey;
    if (!mod) return;

    if (e.key === 'e' && !e.shiftKey) {
      e.preventDefault();
      setMode(currentMode === 'preview' ? 'split' : 'preview');
    } else if (e.key === 'E' && e.shiftKey) {
      e.preventDefault();
      setMode(currentMode === 'edit' ? 'split' : 'edit');
    }
  });

  /* â”€â”€ Tab key in editor â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  editor.addEventListener('keydown', e => {
    if (e.key === 'Tab') {
      e.preventDefault();
      const start = editor.selectionStart;
      const end = editor.selectionEnd;
      editor.value = editor.value.substring(0, start) + '  ' + editor.value.substring(end);
      editor.selectionStart = editor.selectionEnd = start + 2;
    }
  });

  /* â”€â”€ Scroll sync â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  editor.addEventListener('scroll', () => {
    if (currentMode !== 'split') return;
    const ratio = editor.scrollTop / (editor.scrollHeight - editor.clientHeight || 1);
    preview.scrollTop = ratio * (preview.scrollHeight - preview.clientHeight);
  });

  /* â”€â”€ Input handling â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  editor.addEventListener('input', () => {
    const len = editor.value.length;
    charCount.textContent = `${len.toLocaleString()} char${len !== 1 ? 's' : ''}`;
    localStorage.setItem(LS_KEY, editor.value);
    scheduleRender();
  });

  /* â”€â”€ Toast helper â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  let toastTimer;
  function showToast(msg) {
    toast.textContent = msg;
    toast.classList.add('show');
    clearTimeout(toastTimer);
    toastTimer = setTimeout(() => toast.classList.remove('show'), 2000);
  }

  /* â”€â”€ Toolbar buttons â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  document.getElementById('btn-copy-md').addEventListener('click', () => {
    navigator.clipboard.writeText(editor.value).then(() => showToast('âœ“ Markdown copied'));
  });

  document.getElementById('btn-copy-html').addEventListener('click', () => {
    navigator.clipboard.writeText(proseContent.innerHTML).then(() => showToast('âœ“ HTML copied'));
  });

  document.getElementById('btn-clear').addEventListener('click', () => {
    editor.value = '';
    proseContent.innerHTML = '';
    charCount.textContent = '0 chars';
    statusMermaid.classList.remove('visible');
    localStorage.removeItem(LS_KEY);
    editor.focus();
    showToast('Cleared');
  });

  document.getElementById('btn-load-sample').addEventListener('click', () => {
    editor.value = SAMPLE;
    editor.dispatchEvent(new Event('input'));
    editor.focus();
    showToast('Sample loaded');
  });

  /* â”€â”€ Resizable divider â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  let isDragging = false;

  divider.addEventListener('mousedown', e => {
    if (currentMode !== 'split') return;
    isDragging = true;
    document.body.style.cursor = 'col-resize';
    document.body.style.userSelect = 'none';
    e.preventDefault();
  });

  document.addEventListener('mousemove', e => {
    if (!isDragging) return;
    const content = document.getElementById('content');
    const rect = content.getBoundingClientRect();
    const pct = Math.min(Math.max(((e.clientX - rect.left) / rect.width) * 100, 20), 80);
    editorPane.style.width = `${pct}%`;
  });

  document.addEventListener('mouseup', () => {
    if (!isDragging) return;
    isDragging = false;
    document.body.style.cursor = '';
    document.body.style.userSelect = '';
  });

  /* â”€â”€ Sample markdown â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  const SAMPLE = `# Markdown Renderer âœ¨

## Overview

This tool renders **full GitHub-Flavored Markdown** including tables, task lists, code blocks with syntax highlighting, and â€” uniquely â€” **Mermaid diagrams** directly in your browser.

> ðŸ’¡ VSCode doesn't render Mermaid natively. This tool does.

---

## Text Formatting

Normal text with **bold**, *italic*, ~~strikethrough~~, and \`inline code\`.

---

## Code Block (JavaScript)

\`\`\`javascript
async function fetchUser(id) {
  const res = await fetch(\`/api/users/\${id}\`);
  if (!res.ok) throw new Error(\`HTTP \${res.status}\`);
  const { name, email } = await res.json();
  return { name, email };
}
\`\`\`

---

## Mermaid â€” Flowchart

\`\`\`mermaid
flowchart TD
    A([ðŸš€ Start]) --> B{Is user logged in?}
    B -- Yes --> C[Load dashboard]
    B -- No --> D[Show login page]
    D --> E[User enters credentials]
    E --> F{Valid?}
    F -- Yes --> C
    F -- No --> G[Show error]
    G --> D
    C --> H([âœ… Done])
\`\`\`

---

## Mermaid â€” Sequence Diagram

\`\`\`mermaid
sequenceDiagram
    participant Client
    participant API
    participant DB

    Client->>API: POST /auth/login
    API->>DB: SELECT user WHERE email=?
    DB-->>API: User record
    API->>API: Validate password hash
    API-->>Client: 200 OK + JWT token
    Client->>API: GET /dashboard (Bearer token)
    API->>API: Verify JWT
    API-->>Client: Dashboard data
\`\`\`

---

## Mermaid â€” Pie Chart

\`\`\`mermaid
pie title Browser Market Share 2024
    "Chrome" : 65.7
    "Safari" : 18.6
    "Firefox" : 4.0
    "Edge" : 5.1
    "Other" : 6.6
\`\`\`

---

## Task List

- [x] Full GFM parsing
- [x] Mermaid diagram rendering
- [x] Syntax-highlighted code blocks
- [x] Split / Edit / Preview modes
- [ ] Export to PDF (coming soon)
- [ ] File drag & drop

---

## Table

| Feature | Supported | Notes |
|---|:---:|---|
| Headers H1â€“H6 | âœ… | With border on H1, H2 |
| Bold / Italic | âœ… | GFM spec |
| Tables | âœ… | With alignment |
| Task Lists | âœ… | Checkboxes |
| Code Blocks | âœ… | 180+ languages |
| Mermaid Diagrams | âœ… | Flowchart, Sequence, Ganttâ€¦ |
| Images | âœ… | Max-width constrained |
| Blockquotes | âœ… | Styled with left border |

---

## Blockquote

> "The best tool is the one you always have open."
>
> â€” probably someone on Hacker News

---

## Ordered List

1. Open the tool
2. Paste your markdown
3. Toggle to **Preview** mode
4. Enjoy rendered Mermaid diagrams

---

## Nested Lists

- Frontend
  - React
  - Vue
  - Svelte
- Backend
  - Node.js
    - Express
    - Fastify
  - Go
  - Rust

---

## Mermaid â€” Gantt

\`\`\`mermaid
gantt
    title Project Timeline
    dateFormat  YYYY-MM-DD
    section Planning
    Requirements   :done, req, 2024-01-01, 7d
    Architecture   :done, arch, after req, 5d
    section Development
    Backend API    :active, api, 2024-01-13, 14d
    Frontend UI    :ui, after api, 10d
    section Release
    QA Testing     :qa, after ui, 7d
    Deploy         :deploy, after qa, 2d
\`\`\`
`;

  /* â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  const saved = localStorage.getItem(LS_KEY);
  if (saved) {
    editor.value = saved;
    charCount.textContent = `${saved.length.toLocaleString()} chars`;
    render();
  } else {
    editor.value = SAMPLE;
    charCount.textContent = `${SAMPLE.length.toLocaleString()} chars`;
    render();
  }

  /* â”€â”€ Diagram viewer modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  const dmModal     = document.getElementById('diagram-modal');
  const dmCanvas    = document.getElementById('dm-canvas');
  const dmInner     = document.getElementById('dm-inner');
  const dmTitle     = document.getElementById('dm-title');
  const dmZoomDisp  = document.getElementById('dm-zoom-display');
  const dmZoomBadge = document.getElementById('dm-zoom-badge');
  const dmBtnZoomIn  = document.getElementById('dm-btn-zoom-in');
  const dmBtnZoomOut = document.getElementById('dm-btn-zoom-out');
  const dmBtnFit     = document.getElementById('dm-btn-fit');
  const dmClose      = document.getElementById('dm-close');

  let dmZoom = 1;
  let dmPanX = 0;
  let dmPanY = 0;
  let dmModalOpen = false;
  let dmDragging = false;
  let dmDragStartX = 0;
  let dmDragStartY = 0;
  let dmDragOriginX = 0;
  let dmDragOriginY = 0;

  function dmApplyTransform() {
    dmInner.style.transform = `translate(calc(-50% + ${dmPanX}px), calc(-50% + ${dmPanY}px)) scale(${dmZoom})`;
    const pct = `${Math.round(dmZoom * 100)}%`;
    dmZoomDisp.textContent = pct;
    dmZoomBadge.textContent = pct;
  }

  function dmFit() {
    const svgEl = dmInner.querySelector('svg');
    if (!svgEl) return;
    const canvasRect = dmCanvas.getBoundingClientRect();
    const vb = svgEl.viewBox.baseVal;
    const svgW = vb && vb.width ? vb.width : svgEl.getBoundingClientRect().width;
    const svgH = vb && vb.height ? vb.height : svgEl.getBoundingClientRect().height;
    if (!svgW || !svgH) return;
    dmZoom = Math.min((canvasRect.width - 80) / svgW, (canvasRect.height - 80) / svgH, 4);
    dmZoom = Math.max(0.1, dmZoom);
    dmPanX = 0;
    dmPanY = 0;
    dmApplyTransform();
  }

  function dmZoomBy(delta) {
    dmZoom = Math.min(8, Math.max(0.1, dmZoom + delta));
    dmApplyTransform();
  }

  function dmZoomTo(factor, originX, originY) {
    const canvasRect = dmCanvas.getBoundingClientRect();
    const cx = originX - canvasRect.left - canvasRect.width / 2;
    const cy = originY - canvasRect.top - canvasRect.height / 2;
    const prevZoom = dmZoom;
    dmZoom = Math.min(8, Math.max(0.1, dmZoom * factor));
    const scale = dmZoom / prevZoom;
    dmPanX = cx - scale * (cx - dmPanX);
    dmPanY = cy - scale * (cy - dmPanY);
    dmApplyTransform();
  }

  function openDiagramModal(svgEl, title) {
    dmInner.innerHTML = '';
    dmInner.appendChild(svgEl);
    dmTitle.textContent = title || 'Diagram';
    dmZoom = 1; dmPanX = 0; dmPanY = 0;
    dmModal.classList.add('open');
    dmModalOpen = true;
    requestAnimationFrame(() => {
      dmFit();
      dmModal.classList.add('visible');
    });
  }

  function closeDiagramModal() {
    dmModal.classList.remove('visible');
    dmModalOpen = false;
    setTimeout(() => {
      dmModal.classList.remove('open');
      dmInner.innerHTML = '';
    }, 180);
  }

  // Pan â€” mousedown on canvas
  dmCanvas.addEventListener('mousedown', e => {
    if (e.button !== 0) return;
    dmDragging = true;
    dmDragStartX = e.clientX;
    dmDragStartY = e.clientY;
    dmDragOriginX = dmPanX;
    dmDragOriginY = dmPanY;
    dmCanvas.classList.add('dragging');
    e.preventDefault();
  });

  document.addEventListener('mousemove', e => {
    if (!dmDragging) return;
    dmPanX = dmDragOriginX + (e.clientX - dmDragStartX);
    dmPanY = dmDragOriginY + (e.clientY - dmDragStartY);
    dmApplyTransform();
  });

  document.addEventListener('mouseup', () => {
    if (!dmDragging) return;
    dmDragging = false;
    dmCanvas.classList.remove('dragging');
  });

  // Zoom on wheel
  dmCanvas.addEventListener('wheel', e => {
    e.preventDefault();
    const factor = e.deltaY < 0 ? 1.12 : 1 / 1.12;
    dmZoomTo(factor, e.clientX, e.clientY);
  }, { passive: false });

  // Toolbar buttons
  dmBtnZoomIn.addEventListener('click',  () => dmZoomBy(0.2));
  dmBtnZoomOut.addEventListener('click', () => dmZoomBy(-0.2));
  dmBtnFit.addEventListener('click',     () => dmFit());
  dmClose.addEventListener('click',      () => closeDiagramModal());

  // Click on backdrop closes modal
  dmModal.addEventListener('click', e => {
    if (e.target === dmModal || e.target === dmCanvas) closeDiagramModal();
  });
  editor.focus();
})();
</script>
</body>
</html>
